---
title: "AnVILWorkflow: Run non-R workflows implemented in Terra using R"
author: "Sehyun Oh"
date: "`r format(Sys.time(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Quickstart}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>", collapse = TRUE, fig.align = 'center', eval = FALSE
)
```

# Overview

For R users with the limited computing resources, we introduce the
AnVILWorkflow package. This package allows users to run workflows
implemented in [Terra](https://app.terra.bio/#) without writing any
workflow, installing software, or managing cloud resources. Terra is a
cloud-based genomics platform and its computing resources rely on Google
Cloud Platform (GCP). To use AnVILWorkflow, you only need to setup the
Terra account once at the beginning.

## Load packages

```{r eval=TRUE, message=FALSE}
library(AnVIL)
library(AnVILWorkflow)
```

## Create Terra account

You need [Terra account
setup](https://support.terra.bio/hc/en-us/articles/360034677651-Account-setup-and-exploring-Terra).
Once you have your own Terra account, you need two pieces of information
from it to use AnVILWorkflow package:

1)  The email address linked to your Terra account\
2)  Your billing project name

**Modify these with YOUR account information!**

```{r eval=FALSE}
accountEmail <- "YOUR_EMAIL@gmail.com"
billingProjectName <- "YOUR_BILLING_ACCOUNT"

setCloudEnv(accountEmail = accountEmail, 
            billingProjectName = billingProjectName)
```

```{r echo=FALSE}
accountEmail <- "shbrief@gmail.com"
billingProjectName <- "waldronlab-terra-rstudio"
setCloudEnv(accountEmail = accountEmail, 
            billingProjectName = billingProjectName,
            message = FALSE)
```

## Major steps

Here is the table of major functions for three workflow steps - prepare,
run, and check result.

| Steps   | Functions           | Description                               |
|---------|---------------------|-------------------------------------------|
| Prepare | `cloneWorkspace`    | Copy the template workspace               |
|         | `updateInput`       | Take user's inputs                        |
| Run     | `runWorkflow`       | Launch the workflow in Terra              |
|         | `stopWorkflow`      | Abort the submission                      |
|         | `monitorWorkflow`   | Monitor the status of your workflow run   |
| Result  | `getOutput`         | List or download your workflow outputs    |


## Google Cloud SDK

If you use AnVILWorkflow within Terra's RStudio, you don't need extra
authentication and gcloud SDK. If you use this package from a local
machine, it requires gcloud SDK and the billing account used in Terra.
You can [install](https://cloud.google.com/sdk/docs/install) the gcloud
sdk.

Check whether your system has the installation with `AnVIL::gcloud_exists()`

```{r}
## gcloud_exists() should return TRUE to use AnVILWorkflow package
gcloud_exists()
```

If it returns `FALSE`, install the gcloud SDK following this script:

```{bash eval=FALSE, echo=FALSE}
curl -sSL https://sdk.cloud.google.com | bash
```

```{r eval=FALSE}
devtools::install_github("rstudio/cloudml")
cloudml::gcloud_install()
```

```{bash eval=FALSE}
## From terminal
gcloud auth login
```

```{r eval=FALSE, echo=FALSE}
## You can change the project using this script
gcloud config set project PROJECT_ID
```


## Example in this vignette: Bulk RNAseq analysis

You can find the currently available workflows using `availableAnalysis()` 
function. The values under `analysis` column can be used for the analysis 
argument. For this vignette, we use `"salmon"`.

```{r eval=TRUE}
availableAnalysis()

analysis <- "salmon"
```

# Setup

## Clone Workspace

First, you should clone the template workspace using `cloneWorkspace`
function. Note that you need to provide a **unique** name for the cloned
workspace through `workspaceName` argument.

```{r}
workspaceName <- "salmon_test"
```

If you attempt to clone the template workspace using the existing
workspaceName, you will get the below error message.

```{r}
cloneWorkspace(workspaceName = "salmon_test", 
               analysis = "salmon")
```

With the unique workspace name, you can successfully clone the workspace
and the function will return the name of the cloned workspace.

```{r}
cloneWorkspace(workspaceName = "salmon_test2", analysis)
```

If you want to clone a workspace that's not curated by this pacakge,
you can directly enter it's workspaceName as a `templateName`. For example,
to clone `Tumor_Only_CNV` workfspace:

```{r}
cloneWorkspace(workspaceName = "cnv_test",
               templateName = "Tumor_Only_CNV")
```

```{r echo=FALSE, message=FALSE}
## Delete test workspaces
resp <- AnVIL::Terra()$deleteWorkspace(workspaceNamespace = billingProjectName,
                                       workspaceName = "salmon_test2")
rm(resp)

resp <- AnVIL::Terra()$deleteWorkspace(workspaceNamespace = billingProjectName,
                                       workspaceName = "cnv_test")
rm(resp)
```

## Prepare Input

### Current input

You can review the current inputs using `currentInput` function. Below
shows all the required and optional inputs for the workflow.

```{r}
current_input <- currentInput(workspaceName)
current_input
```

<br>

### Update input
You can modify/update inputs of your workflow using `updateInput` function. To
minimize the formatting issues, we recommend to make any change in the current 
input table returned from the `currentInput` function. Under the default 
(\code{dry=TRUE}), the updated input table will be returned without actually
updating Terra/AnVIL. Set \code{dry=FALSE}, to make a change in Terra/AnVIL.

```{r}
new_input <- current_input
new_input[4,4] <- "athal_index"
new_input

updateInput(workspaceName = "salmon_test",
            inputs = new_input)
```


# Run bioBakery workflow

You can launch the workflow using `runWorkflow` function.

```{r error=TRUE}
runWorkflow(workspaceName)
runWorkflow(workspaceName, inputName = "AnVILBulkRNASeq_set")
```

## Monitor Progress

The last three columns show the submission and the result status.

```{r}
submissions <- monitorWorkflow(workspaceName)
submissions
```

## Abort submission

You can abort the most recently submitted job using the `stopWorkflow` 
function. If you want to abort any workflow that is not the most recently
submitted, please provide `submissionId`.

```{r}
stopWorkflow(workspaceName)
```

# Result

```{r}
output_from_aborted <- getOutput(workspaceName = "salmon_test")
dim(output_from_aborted)

out <- getOutput(workspaceName = "salmon_test",
                 submissionId = "73f16bcd-eaf9-4c2d-99ce-c455a1044025")
dim(out)
```


You can check all the output files from the most recently succeeded
submission using `getOutput` function. If you specify the `submissionId` 
argument, you can get the output files of that specific submission.

# Session Info

```{r eval=TRUE}
sessionInfo()
```
